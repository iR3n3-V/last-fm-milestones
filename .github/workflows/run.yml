name: telegram runner

on:
  workflow_dispatch:
    inputs:
      entity:
        description: "art | alb | trk"
        required: true
        type: string
      count:
        description: "optional milestone (es: 100)"
        required: false
        type: string
      username:
        description: "username last.fm"
        required: true
        type: string
      chatId:
        description: "telegram chat id"
        required: true
        type: string

jobs:
  run-milestone:
    runs-on: ubuntu-22.04
    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: setup python
        uses: actions/setup-python@v6   # aggiornato alla v6 per cache nativa
        with:
          python-version: '3.11'
          cache: 'pip'                  # attiva il caching pip
          cache-dependency-path: 'requirements.txt'

      - name: install requirements
        run: |
          pip install -r requirements.txt

      - name: run script and capture output
        env:
          LASTFM_API_KEY: ${{ secrets.LASTFM_API_KEY }}
          LASTFM_USERNAME: ${{ secrets.LASTFM_USERNAME }}
        run: |
          entity="${{ github.event.inputs.entity }}"
          count="${{ github.event.inputs.count }}"
          username="${{ github.event.inputs.username }}"
          
          # se count non √® impostato ‚Üí passa stringa vuota
          if [ -z "$count" ]; then
              count=""
          fi
          
          args="$entity" 
          args="$args $count"
          args="$args $username"

          python milestone.py "$entity" "$count" "$username" > raw_output.txt
          cat raw_output.txt


      - name: run script and send to telegram (HTML, chunked)
        env:
          LASTFM_API_KEY: ${{ secrets.LASTFM_API_KEY }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        run: |
          safe_chunk_size=3500  # margine maggiore
          chat_id="${{ github.event.inputs.chatId }}"
          entity="${{ github.event.inputs.entity }}"
          count="${{ github.event.inputs.count }}"
          username="${{ github.event.inputs.username }}"
          
          if [ -z "$count" ]; then
              count=""
          fi
          
          raw="$(cat raw_output.txt)"
          
          current_chunk=""
          block=""
          
          while IFS= read -r line; do
              # nuovo blocco logico
              if [[ "$line" =~ ^(üé§|üíø|üéµ|üèÅ) ]]; then
                  if [ -n "$block" ]; then
                      if [ $(( ${#current_chunk} + ${#block} )) -ge $safe_chunk_size ]; then
                          # controlla se finisce con backslash
                          while [[ "$current_chunk" =~ \\$ ]]; do
                              # sposta l'ultimo backslash al blocco successivo
                              block="\\${block}"
                              current_chunk="${current_chunk%?}"
                          done
          
                          echo "---- CHUNK START ----"
                          echo "$current_chunk"
                          echo "---- CHUNK END ----"

                          safe_text="${current_chunk//+/\\+}"
                          
                          curl -s -X POST "https://lastfmmilestones.simonevalent2000.workers.dev/push" \
                            -F "chatId=$chat_id" \
                            -F "text=$current_chunk"
                          current_chunk="$block"
                      else
                          current_chunk+="$block"
                      fi
                  fi
                  block="$line"$'\n'
              else
                  block+="$line"$'\n'
              fi
          done <<< "$raw"
          
          # invio ultimo blocco
          if [ -n "$block" ]; then
              if [ $(( ${#current_chunk} + ${#block} )) -ge $safe_chunk_size ]; then
                  while [[ "$current_chunk" =~ \\$ ]]; do
                      block="\\${block}"
                      current_chunk="${current_chunk%?}"
                  done
          
                  echo "---- CHUNK START ----"
                  echo "$current_chunk"
                  echo "---- CHUNK END ----"

                  safe_text="${current_chunk//+/\\+}"
          
                  curl -s -X POST "https://lastfmmilestones.simonevalent2000.workers.dev/push" \
                    -F "chatId=$chat_id" \
                    -F "text=$current_chunk"
                  current_chunk="$block"
              else
                  current_chunk+="$block"
              fi
          fi
          
          if [ -n "$current_chunk" ]; then
              echo "---- CHUNK START ----"
              echo "$current_chunk"
              echo "---- CHUNK END ----"

              safe_text="${current_chunk//+/\\+}"
          
              curl -s -X POST "https://lastfmmilestones.simonevalent2000.workers.dev/push" \
                -F "chatId=$chat_id" \
                -F "text=$current_chunk"
          fi
