name: telegram runner

on:
  workflow_dispatch:
    inputs:
      entity:
        description: "art | alb | trk"
        required: true
      count:
        description: "optional milestone (es: 100)"
        required: false
      username:
        description: "username last.fm"
        required: true

jobs:
  run-milestone:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: setup python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: run script and capture output
        env:
          LASTFM_API_KEY: ${{ secrets.LASTFM_API_KEY }}
        run: |
          python milestone.py "${{ github.event.inputs.entity }}" "${{ github.event.inputs.count }}" "${{ github.event.inputs.username }}" > result.txt || true
          cat result.txt

      - name: send to telegram (debug & multi-message)
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          echo "--- DEBUG: reading result.txt ---"
          raw="$(cat result.txt || true)"
          echo "RAW CONTENT:"
          echo "$raw"
          echo "--- END RAW ---"

          if [ -z "$raw" ]; then
            echo "⚠ raw vuoto, invio messaggio fallback"
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d chat_id="${CHAT_ID}" \
              -d text="⚠ risultato vuoto" \
              -d parse_mode="MarkdownV2"
            exit 0
          fi

          # escape markdown v2 (senza funzioni esterne)
          echo "--- DEBUG: escaping markdown ---"
          out="$raw"
          out="$(echo "$out" | sed 's/\\/\\\\/g')"
          out="$(echo "$out" | sed 's/\_/\\_/g')"
          out="$(echo "$out" | sed 's/\*/\\*/g')"
          out="$(echo "$out" | sed 's/\[/\\[/g')"
          out="$(echo "$out" | sed 's/\]/\\]/g')"
          out="$(echo "$out" | sed 's/(/\\(/g')"
          out="$(echo "$out" | sed 's/)/\\)/g')"
          out="$(echo "$out" | sed 's/\./\\./g')"
          out="$(echo "$out" | sed 's/\!/\\!/g')"
          echo "--- AFTER ESCAPE ---"
          echo "$out"
          echo "--- END ESCAPE ---"

          MAX=3800

          echo "--- START SENDING MESSAGES ---"
          while [ ${#out} -gt $MAX ]; do
            part="${out:0:$MAX}"
            echo "> sending chunk of ${#part} chars"
            
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
              -d chat_id="${CHAT_ID}" \
              -d parse_mode="MarkdownV2" \
              -d disable_web_page_preview=true \
              --data-urlencode "text=$part"

            out="${out:$MAX}"
            sleep 0.2
          done

          echo "> sending final chunk of ${#out} chars"
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d parse_mode="MarkdownV2" \
            -d disable_web_page_preview=true \
            --data-urlencode "text=$out"

          echo "--- DONE ---"
