name: telegram runner

on:
  workflow_dispatch:
    inputs:
      entity:
        description: "art | alb | trk"
        required: true
      count:
        description: "optional milestone (es: 100)"
        required: false
      username:
        description: "username last.fm"
        required: true

jobs:
  run-milestone:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: setup python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: run script and capture output
        env:
          LASTFM_API_KEY: ${{ secrets.LASTFM_API_KEY }}
        run: |
          python milestone.py "${{ github.event.inputs.entity }}" "${{ github.event.inputs.count }}" "${{ github.event.inputs.username }}" > result.txt || true
          cat result.txt

      - name: run script and send to telegram (HTML, chunked)
        env:
          LASTFM_API_KEY: ${{ secrets.LASTFM_API_KEY }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          chunk_size=3800
          raw="$(python milestone.py "${{ github.event.inputs.entity }}" "${{ github.event.inputs.count }}" "${{ github.event.inputs.username }}")"
          
          current_chunk=""
          block=""
          
          while IFS= read -r line; do
              # se la riga inizia con un simbolo, significa nuovo blocco
              if [[ "$line" =~ ^(ðŸŽ¤|ðŸ’¿|ðŸŽµ) ]]; then
                  # invia il blocco precedente se aggiungerlo al chunk supera chunk_size
                  if [ -n "$block" ]; then
                      if [ $(( ${#current_chunk} + ${#block} )) -ge $chunk_size ]; then
                          echo "sending chunk..."
                          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
                              -d chat_id="${CHAT_ID}" \
                              -d parse_mode="MarkdownV2" \
                              -d disable_web_page_preview=true \
                              --data-urlencode "text=$current_chunk"
                          sleep 0.2
                          current_chunk="$block"
                      else
                          current_chunk+="$block"
                      fi
                  fi
                  block="$line"$'\n'  # nuovo blocco
              else
                  block+="$line"$'\n'
              fi
          done <<< "$raw"
          
          # aggiungi l'ultimo blocco rimasto
          if [ -n "$block" ]; then
              if [ $(( ${#current_chunk} + ${#block} )) -ge $chunk_size ]; then
                  echo "sending chunk..."
                  curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
                      -d chat_id="${CHAT_ID}" \
                      -d parse_mode="MarkdownV2" \
                      -d disable_web_page_preview=true \
                      --data-urlencode "text=$current_chunk"
                  current_chunk="$block"
                  sleep 0.2
              else
                  current_chunk+="$block"
              fi
          fi
          
          # invia il chunk finale
          if [ -n "$current_chunk" ]; then
              curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
                  -d chat_id="${CHAT_ID}" \
                  -d parse_mode="MarkdownV2" \
                  -d disable_web_page_preview=true \
                  --data-urlencode "text=$current_chunk"
          fi
          
